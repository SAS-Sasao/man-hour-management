'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Layout from '../../components/Layout';
import { useApp } from '../../contexts/AppContext';

export default function Dashboard() {
  const { state } = useApp();
  const router = useRouter();

  useEffect(() => {
    if (!state.currentUser) {
      router.push('/login');
    }
  }, [state.currentUser, router]);

  if (!state.currentUser) {
    return null;
  }

  // ÁèæÂú®„ÅÆÊó•ÊôÇÊÉÖÂ†±
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
  const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;

  // Ëá™ÂàÜ„ÅÆÂ∑•Êï∞„Éá„Éº„Çø„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ôºà„É°„É≥„Éê„Éº„ÅÆÂ†¥ÂêàÔºâ
  const userTimeEntries = state.currentUser?.role === 'MEMBER' 
    ? state.timeEntries.filter(entry => entry.userId === state.currentUser.id)
    : state.timeEntries;

  const stats = {
    totalProjects: state.projects.length,
    activeProjects: state.projects.filter(p => p.status === 'active').length,
    totalUsers: state.users.length,
    thisMonthHours: userTimeEntries
      .filter(entry => {
        return entry.date.getMonth() === thisMonth && 
               entry.date.getFullYear() === thisYear;
      })
      .reduce((sum, entry) => sum + entry.hours, 0),
    lastMonthHours: userTimeEntries
      .filter(entry => {
        return entry.date.getMonth() === lastMonth && 
               entry.date.getFullYear() === lastMonthYear;
      })
      .reduce((sum, entry) => sum + entry.hours, 0),
    totalHours: userTimeEntries.reduce((sum, entry) => sum + entry.hours, 0),
    averageDailyHours: userTimeEntries.length > 0 
      ? userTimeEntries.reduce((sum, entry) => sum + entry.hours, 0) / 
        Math.max(1, [...new Set(userTimeEntries.map(entry => entry.date.toDateString()))].length)
      : 0
  };

  // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂà•ÈõÜË®à
  const projectStats = state.projects.map(project => {
    const projectEntries = userTimeEntries.filter(entry => entry.projectId === project.id);
    const totalHours = projectEntries.reduce((sum, entry) => sum + entry.hours, 0);
    const thisMonthProjectHours = projectEntries
      .filter(entry => entry.date.getMonth() === thisMonth && entry.date.getFullYear() === thisYear)
      .reduce((sum, entry) => sum + entry.hours, 0);
    
    return {
      ...project,
      totalHours,
      thisMonthHours: thisMonthProjectHours,
      progressPercentage: project.endDate 
        ? Math.min(100, ((now.getTime() - project.startDate.getTime()) / 
                        (project.endDate.getTime() - project.startDate.getTime())) * 100)
        : 0
    };
  }).filter(project => project.totalHours > 0).sort((a, b) => b.totalHours - a.totalHours);

  // Â∑•Á®ãÂà•ÈõÜË®à
  const phaseStats = state.phases.map(phase => {
    const phaseEntries = userTimeEntries.filter(entry => entry.phaseId === phase.id);
    const totalHours = phaseEntries.reduce((sum, entry) => sum + entry.hours, 0);
    
    return {
      ...phase,
      totalHours,
      project: state.projects.find(p => p.id === phase.projectId)
    };
  }).filter(phase => phase.totalHours > 0).sort((a, b) => b.totalHours - a.totalHours);

  return (
    <Layout>
      <div className="space-y-6">
        <div className="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-2xl p-6 text-white">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
              <p className="text-blue-100 mt-2">
                „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å®Â∑•Êï∞„ÅÆÊ¶ÇË¶Å„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô
              </p>
            </div>
            <div className="text-6xl opacity-20">üìä</div>
          </div>
        </div>

        <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
          <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-lg rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center">
                    <span className="text-2xl">üìã</span>
                  </div>
                </div>
                <div className="ml-5 w-0 flex-1">
                  <dl>
                    <dt className="text-sm font-medium text-gray-500 truncate">
                      Á∑è„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊï∞
                    </dt>
                    <dd className="text-2xl font-bold text-gray-900">
                      {stats.totalProjects}
                    </dd>
                    <dd className="text-xs text-gray-500">
                      Ê¥ªÂãï‰∏≠: {stats.activeProjects}‰ª∂
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-lg rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center">
                    <span className="text-2xl">‚è∞</span>
                  </div>
                </div>
                <div className="ml-5 w-0 flex-1">
                  <dl>
                    <dt className="text-sm font-medium text-gray-500 truncate">
                      {state.currentUser?.role === 'MEMBER' ? '‰ªäÊúà„ÅÆ‰ΩúÊ•≠ÊôÇÈñì' : '‰ªäÊúà„ÅÆÁ∑èÂ∑•Êï∞'}
                    </dt>
                    <dd className="text-2xl font-bold text-gray-900">
                      {stats.thisMonthHours.toFixed(1)}h
                    </dd>
                    <dd className="text-xs text-gray-500">
                      ÂâçÊúà: {stats.lastMonthHours.toFixed(1)}h
                      {stats.lastMonthHours > 0 && (
                        <span className={`ml-1 ${stats.thisMonthHours > stats.lastMonthHours ? 'text-green-600' : 'text-red-600'}`}>
                          ({stats.thisMonthHours > stats.lastMonthHours ? '+' : ''}{((stats.thisMonthHours - stats.lastMonthHours) / Math.max(1, stats.lastMonthHours) * 100).toFixed(1)}%)
                        </span>
                      )}
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-lg rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                    <span className="text-2xl">üìä</span>
                  </div>
                </div>
                <div className="ml-5 w-0 flex-1">
                  <dl>
                    <dt className="text-sm font-medium text-gray-500 truncate">
                      {state.currentUser?.role === 'MEMBER' ? 'Á∑è‰ΩúÊ•≠ÊôÇÈñì' : 'Á∑èÂ∑•Êï∞'}
                    </dt>
                    <dd className="text-2xl font-bold text-gray-900">
                      {stats.totalHours.toFixed(1)}h
                    </dd>
                    <dd className="text-xs text-gray-500">
                      1Êó•Âπ≥Âùá: {stats.averageDailyHours.toFixed(1)}h
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-lg rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
                    <span className="text-2xl">üë•</span>
                  </div>
                </div>
                <div className="ml-5 w-0 flex-1">
                  <dl>
                    <dt className="text-sm font-medium text-gray-500 truncate">
                      {state.currentUser?.role === 'MEMBER' ? 'ÂèÇÂä†„Éó„É≠„Ç∏„Çß„ÇØ„Éà' : 'Á∑è„É¶„Éº„Ç∂„ÉºÊï∞'}
                    </dt>
                    <dd className="text-2xl font-bold text-gray-900">
                      {state.currentUser?.role === 'MEMBER' ? projectStats.length : stats.totalUsers}
                    </dd>
                    <dd className="text-xs text-gray-500">
                      {state.currentUser?.role === 'MEMBER' ? '„Éó„É≠„Ç∏„Çß„ÇØ„Éà' : '„É¶„Éº„Ç∂„Éº'}
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂà•Áµ±Ë®à„Å®BIÈõÜË®à */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white/80 backdrop-blur-sm shadow-lg rounded-2xl border border-white/20">
            <div className="px-6 py-6">
              <h3 className="text-xl leading-6 font-bold text-gray-900 mb-4 flex items-center">
                <span className="text-2xl mr-3">üìä</span>
                „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂà•ÈõÜË®à
              </h3>
              <div className="space-y-3">
                {projectStats.slice(0, 5).map((project) => (
                  <div key={project.id} className="p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border border-gray-100">
                    <div className="flex items-center justify-between mb-2">
                      <div>
                        <p className="text-sm font-semibold text-gray-900">{project.name}</p>
                        <p className="text-xs text-gray-500">
                          ‰ªäÊúà: {project.thisMonthHours.toFixed(1)}h / Á¥ØË®à: {project.totalHours.toFixed(1)}h
                        </p>
                      </div>
                      <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        project.status === 'active' ? 'bg-green-100 text-green-800' :
                        project.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                        'bg-yellow-100 text-yellow-800'
                      }`}>
                        {project.status === 'active' ? 'ÈÄ≤Ë°å‰∏≠' :
                         project.status === 'completed' ? 'ÂÆå‰∫Ü' : '‰øùÁïô'}
                      </span>
                    </div>
                    {project.endDate && (
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div 
                          className="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300"
                          style={{ width: `${Math.min(100, project.progressPercentage)}%` }}
                        ></div>
                      </div>
                    )}
                  </div>
                ))}
                {projectStats.length === 0 && (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">üìä</div>
                    <p className="text-gray-500">‰ΩúÊ•≠„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div className="bg-white/80 backdrop-blur-sm shadow-lg rounded-2xl border border-white/20">
            <div className="px-6 py-6">
              <h3 className="text-xl leading-6 font-bold text-gray-900 mb-4 flex items-center">
                <span className="text-2xl mr-3">üîß</span>
                Â∑•Á®ãÂà•ÈõÜË®à
              </h3>
              <div className="space-y-3">
                {phaseStats.slice(0, 5).map((phase) => (
                  <div key={phase.id} className="flex items-center justify-between p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border border-gray-100">
                    <div>
                      <p className="text-sm font-semibold text-gray-900">{phase.name}</p>
                      <p className="text-xs text-gray-500">
                        {phase.project?.name || '‰∏çÊòé„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà'}
                      </p>
                    </div>
                    <div className="text-right">
                      <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                        {phase.totalHours.toFixed(1)}h
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {((phase.totalHours / Math.max(1, stats.totalHours)) * 100).toFixed(1)}%
                      </div>
                    </div>
                  </div>
                ))}
                {phaseStats.length === 0 && (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">üîß</div>
                    <p className="text-gray-500">Â∑•Á®ã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* ÊúÄËøë„ÅÆÊ¥ªÂãï */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white/80 backdrop-blur-sm shadow-lg rounded-2xl border border-white/20">
            <div className="px-6 py-6">
              <h3 className="text-xl leading-6 font-bold text-gray-900 mb-4 flex items-center">
                <span className="text-2xl mr-3">üìã</span>
                ÊúÄËøë„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà
              </h3>
              <div className="space-y-3">
                {state.projects.slice(0, 5).map((project) => (
                  <div key={project.id} className="flex items-center justify-between p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border border-gray-100 hover:shadow-md transition-shadow duration-200">
                    <div>
                      <p className="text-sm font-semibold text-gray-900">{project.name}</p>
                      <p className="text-xs text-gray-500">{project.description}</p>
                    </div>
                    <div className="flex items-center space-x-2">
                      <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                        project.status === 'active' ? 'bg-green-100 text-green-800 border border-green-200' :
                        project.status === 'completed' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
                        'bg-yellow-100 text-yellow-800 border border-yellow-200'
                      }`}>
                        {project.status === 'active' ? 'üöÄ ÈÄ≤Ë°å‰∏≠' :
                         project.status === 'completed' ? '‚úÖ ÂÆå‰∫Ü' : '‚è∏Ô∏è ‰øùÁïô'}
                      </span>
                    </div>
                  </div>
                ))}
                {state.projects.length === 0 && (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">üìã</div>
                    <p className="text-gray-500">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div className="bg-white/80 backdrop-blur-sm shadow-lg rounded-2xl border border-white/20">
            <div className="px-6 py-6">
              <h3 className="text-xl leading-6 font-bold text-gray-900 mb-4 flex items-center">
                <span className="text-2xl mr-3">‚è∞</span>
                {state.currentUser?.role === 'MEMBER' ? 'ÊúÄËøë„ÅÆ‰ΩúÊ•≠Â±•Ê≠¥' : 'ÊúÄËøë„ÅÆÂ∑•Êï∞ÂÖ•Âäõ'}
              </h3>
              <div className="space-y-3">
                {userTimeEntries
                  .sort((a, b) => b.date.getTime() - a.date.getTime())
                  .slice(0, 5)
                  .map((entry) => {
                    const project = state.projects.find(p => p.id === entry.projectId);
                    const user = state.users.find(u => u.id === entry.userId);
                    const phase = state.phases.find(p => p.id === entry.phaseId);
                    const task = state.tasks.find(t => t.id === entry.taskId);
                    return (
                      <div key={entry.id} className="flex items-center justify-between p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border border-gray-100 hover:shadow-md transition-shadow duration-200">
                        <div>
                          <p className="text-sm font-semibold text-gray-900">
                            {project?.name || '‰∏çÊòé„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà'}
                          </p>
                          <p className="text-xs text-gray-500">
                            {state.currentUser?.role !== 'MEMBER' && (user?.name || '‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº') + ' ‚Ä¢ '}
                            {phase?.name || '‰∏çÊòé„Å™Â∑•Á®ã'} ‚Ä¢ {entry.date.toLocaleDateString('ja-JP')}
                          </p>
                          {entry.description && (
                            <p className="text-xs text-gray-400 mt-1 truncate">{entry.description}</p>
                          )}
                        </div>
                        <div className="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                          {entry.hours}h
                        </div>
                      </div>
                    );
                  })}
                {userTimeEntries.length === 0 && (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">‚è∞</div>
                    <p className="text-gray-500">Â∑•Êï∞ÂÖ•Âäõ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </Layout>
  );
}