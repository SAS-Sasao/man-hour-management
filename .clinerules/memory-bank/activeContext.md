# アクティブコンテキスト

## 現在の作業フォーカス

### 🎉 Vercelデプロイ完了状況
- **本番環境**: ✅ Vercel + Neon PostgreSQL で稼働中
- **工数管理システムの基本機能**: ✅ 本番環境で実装完了・動作確認済み
- **ダッシュボード機能**: ✅ 本番環境で実装完了・動作確認済み
- **ユーザー認証・認可**: ✅ 本番環境で実装完了・動作確認済み
- **プロジェクト・工程・タスク管理**: ✅ 本番環境で実装完了・動作確認済み
- **工数入力・編集機能**: ✅ 本番環境で実装完了・動作確認済み
- **一括工数入力機能**: ✅ 本番環境で実装完了・動作確認済み
- **権限制御システム**: ✅ 本番環境で実装完了・動作確認済み
- **組織管理システム**: ✅ 本番環境で実装完了・4階層組織構造対応

### 現在のシステム状態
- **本番稼働中**: Vercel + Neon PostgreSQL で安定稼働
- **実用レベル**: 基本機能が全て動作し、実際の業務で使用可能
- **データ整合性**: Prisma ORMによる型安全なデータ管理が実現
- **セキュリティ**: 認証・認可・パスワードハッシュ化が適切に実装 + 本番環境セキュリティ
- **UI/UX**: レスポンシブデザインで直感的な操作が可能
- **パフォーマンス**: 小〜中規模データでの良好な動作を確認（本番環境）
- **インフラ**: SSL/CDN自動設定、Edge Network活用

### 最近の変更・追加機能
1. **一括工数入力機能** (BulkTimeEntryModal.tsx)
   - 複数日の工数を効率的に入力可能
   - カレンダー形式での日付選択
   - プロジェクト・工程・タスクの連動選択

2. **ダッシュボードの充実**
   - プロジェクト別・工程別の工数集計
   - 月次比較機能
   - 進捗状況の可視化
   - 役割に応じた表示制御

3. **権限管理の実装**
   - ADMIN: 全機能アクセス可能
   - MANAGER: プロジェクト管理・チーム工数確認
   - MEMBER: 自分の工数入力・確認のみ

4. **組織管理システムの実装**
   - 4階層組織構造（会社→事業部→部署→グループ）
   - 組織マスタ管理（Company, Division, Department, Group）
   - ユーザーの組織所属管理
   - 階層的な組織ツリー表示（視覚的改善済み）
   - 組織別統計情報表示

## 次のステップ・優先事項

### 🚨 最優先（本番環境安定化）
1. **本番環境監視・ログ体制**
   - エラー監視システム導入（Sentry等）
   - パフォーマンス監視設定
   - アクセスログ分析・アラート設定
   - 本番環境での異常検知

2. **セキュリティ強化**
   - 本番環境セキュリティ監査
   - 脆弱性スキャン実施
   - セキュリティヘッダー設定
   - 本番データ保護強化

3. **本番環境パフォーマンス最適化**
   - 大量データでの動作検証
   - データベースクエリ最適化
   - 不要な再レンダリング削減
   - メモリ使用量最適化

### 短期的な改善点（1-2週間）
1. **バリデーション・エラーハンドリング強化**
   - 入力値の詳細チェック強化
   - 業務ルールの実装
   - ユーザーフレンドリーなエラーメッセージ
   - 本番環境でのエラー処理改善

2. **CI/CD パイプライン構築**
   - 自動テスト・デプロイ
   - コード品質チェック
   - 本番環境への安全なデプロイ

### 中期的な拡張計画（1ヶ月）
1. **テスト環境構築**
   - 単体テスト実装
   - E2Eテスト環境
   - 本番データを使った負荷テスト

2. **レポート機能の強化**
   - 月次レポートの詳細化
   - CSV/PDF エクスポート機能
   - グラフィカルな進捗表示

3. **運用体制確立**
   - バックアップ・復旧手順
   - 運用ドキュメント整備
   - 障害対応手順書

## アクティブな決定事項・考慮点

### 本番環境での技術的決定
1. **デプロイ環境**: Vercel + Neon PostgreSQL
   - 理由: 自動スケーリング、高可用性、管理の簡素化
   - SSL/CDN自動設定によるセキュリティ・パフォーマンス向上
   - Edge Network活用による高速レスポンス

2. **状態管理**: React Context API を採用（本番環境で安定稼働）
   - 理由: 中規模アプリケーションに適している
   - 本番環境でのパフォーマンス良好を確認
   - 将来的にはZustand等への移行も検討

3. **認証方式**: セッションベース認証を採用（本番環境対応）
   - 理由: シンプルで実装しやすく、本番環境で安定
   - JWT は将来的な検討事項

4. **データベース設計**: 正規化を重視（本番環境最適化）
   - Cascade Delete で整合性確保
   - 本番環境でのインデックス最適化が必要
   - Neon PostgreSQLの特性を活用した設計

### 本番環境開発ルール
5. **型安全性の厳守**: productionRules.mdに詳細記載
   - TypeScript厳密モード必須
   - any型の使用禁止
   - Prisma型の積極活用

6. **Promise・非同期処理**: 統一されたパターン
   - async/await必須使用
   - 包括的エラーハンドリング
   - Promise.allの適切な活用

### UI/UX 決定
1. **デザインシステム**: Tailwind CSS + グラデーション
   - モダンで視覚的に魅力的
   - レスポンシブデザイン対応
   - 一貫性のあるカラーパレット

2. **ナビゲーション**: サイドバー + トップバー
   - 直感的なメニュー構成
   - 役割に応じた表示制御

3. **フォーム設計**: 段階的入力
   - プロジェクト → 工程 → タスクの順序
   - 選択肢の動的フィルタリング

## 重要なパターン・プリファレンス

### 本番環境コーディング規約（厳格化）
1. **TypeScript**: 厳密な型定義を重視（本番環境必須）
   - interface の積極的な活用
   - any型の使用を完全禁止
   - 型安全性を最優先
   - Prisma生成型の必須使用

2. **コンポーネント設計**: 再利用性・パフォーマンスを重視
   - 単一責任の原則
   - Props の型定義を明確に
   - React.memo、useMemo、useCallbackの適切な使用
   - カスタムフックの活用

3. **API設計**: RESTful な設計（本番環境セキュリティ強化）
   - 一貫したレスポンス形式
   - 適切なHTTPステータスコード
   - 包括的エラーハンドリング
   - 認証・認可チェックの必須実装
   - 入力値バリデーションの強化

4. **本番環境セキュリティパターン**
   - 全APIエンドポイントでの認証チェック
   - 権限ベースアクセス制御
   - SQLインジェクション対策（Prisma使用）
   - XSS対策の徹底

### データ処理パターン
1. **工数集計**: クライアントサイドで実行
   - リアルタイムな更新が可能
   - サーバー負荷の軽減
   - 将来的にはサーバーサイド集計も検討

2. **権限制御**: コンポーネントレベルで実装
   - 表示制御とデータフィルタリング
   - セキュリティの多層防御

3. **エラーハンドリング**: ユーザーフレンドリーな表示
   - 技術的詳細は隠蔽
   - 具体的な解決策を提示

## プロジェクトの学び・インサイト

### 成功した実装
1. **Context API の活用**
   - グローバル状態管理が効率的
   - コンポーネント間のデータ共有が簡単
   - パフォーマンスも良好

2. **Prisma ORM の採用**
   - 型安全なデータベースアクセス
   - マイグレーション管理が簡単
   - 開発効率が大幅に向上

3. **段階的な権限制御**
   - 役割ベースの表示制御が効果的
   - セキュリティと使いやすさのバランス

### 課題・改善点
1. **パフォーマンス最適化**
   - 大量データ時の表示速度
   - メモリ使用量の最適化
   - 不要な再レンダリングの削減

2. **テスト環境の不足**
   - 単体テストの未実装
   - E2Eテストの必要性
   - テストデータの管理

3. **エラーハンドリングの改善**
   - より詳細なエラー情報
   - ユーザーガイダンスの充実
   - ログ機能の実装

## 現在のファイル構成・重要度

### 最重要ファイル
1. **src/contexts/AppContext.tsx**: 状態管理の中核
2. **prisma/schema.prisma**: データベース設計
3. **src/components/Layout.tsx**: 共通レイアウト
4. **src/app/dashboard/page.tsx**: メイン画面

### 頻繁に更新されるファイル
1. **src/app/time-entry/page.tsx**: 工数入力画面
2. **src/app/api/time-entries/route.ts**: 工数API
3. **src/components/BulkTimeEntryModal.tsx**: 一括入力機能

### 設定・インフラファイル
1. **package.json**: 依存関係管理
2. **lib/prisma.ts**: データベース接続
3. **.env**: 環境変数設定

## 開発環境・ツール使用状況

### 現在使用中のツール
1. **開発サーバー**: `npm run dev --turbopack`
2. **データベース管理**: Prisma Studio
3. **デバッグ**: ブラウザ開発者ツール + console.log

### 便利なスクリプト
1. **check-db.js**: データベース接続確認
2. **test-api.js**: API動作確認
3. **debug-db.js**: データベース内容確認

## 今後の作業予定

### 🚨 即座に対応すべき項目（本番環境安定化）
1. **本番環境監視**: エラー監視システム導入（Sentry等）
2. **セキュリティ監査**: 本番環境セキュリティチェック
3. **パフォーマンス監視**: 本番環境でのパフォーマンス最適化
4. **バリデーション強化**: 本番データでの入力値チェック改善

### 計画中の機能（本番環境対応）
1. **CI/CD パイプライン**: 本番環境への安全なデプロイ自動化
2. **包括的テスト**: 本番環境を考慮したテスト実装
3. **レポート機能**: 本番データを活用した詳細分析
4. **運用ドキュメント**: 本番環境運用手順書

### 技術的改善（本番環境品質向上）
1. **監視・ログ**: 本番環境運用監視の強化
2. **負荷テスト**: 本番環境での大量データ対応検証
3. **セキュリティ強化**: 本番環境セキュリティの継続的改善
4. **災害復旧**: バックアップ・復旧手順の確立

## 重要な注意事項（本番環境運用）

### 本番環境セキュリティ（最重要）
- パスワードは必ずハッシュ化（bcryptjs使用）
- SQL インジェクション対策（Prisma使用、生SQL禁止）
- XSS対策（適切なエスケープ）
- 認証・認可チェックの必須実装
- 環境変数の適切な管理
- セキュリティヘッダーの設定

### 本番環境パフォーマンス
- 大量データ時の処理速度監視
- メモリリークの防止
- 適切なインデックス設計（Neon PostgreSQL最適化）
- データベースクエリの最適化
- 不要な再レンダリングの削減
- Vercel Function制限（30秒）の考慮

### 本番環境保守性
- コードの可読性維持
- 適切なコメント記述
- 設計ドキュメントの更新
- 本番環境ログの適切な管理
- エラー監視・アラート設定
- 障害対応手順の整備

### 本番環境開発ルール遵守
- `productionRules.md`の厳格な遵守
- 型安全性の確保
- エラーハンドリングの徹底
- パフォーマンス最適化の継続
- セキュリティベストプラクティスの実践
