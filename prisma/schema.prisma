generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String      @id @default(cuid())
  name            String
  email           String      // uniqueåˆ¶ç´„ã‚’å‰Šé™¤ï¼ˆä¼šç¤¾å†…ã§ä¸€æ„ã«ã™ã‚‹ãŸã‚ï¼‰
  password        String
  role            Role        @default(MEMBER)
  
  // çµ„ç¹”æƒ…å ±ï¼ˆNULLè¨±å¯ã§å®‰å…¨ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  companyId       String?     // æ‰€å±ä¼šç¤¾ID
  divisionId      String?     // æ‰€å±äº‹æ¥­éƒ¨ID
  departmentId    String?     // æ‰€å±éƒ¨ç½²ID
  groupId         String?     // æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—ID
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // çµ„ç¹”ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  company         Company?    @relation(fields: [companyId], references: [id])
  division        Division?   @relation(fields: [divisionId], references: [id])
  department      Department? @relation(fields: [departmentId], references: [id])
  group           Group?      @relation(fields: [groupId], references: [id])
  
  // æ—¢å­˜ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  timeEntries     TimeEntry[]
  
  // æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–¢é€£ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  projectManagers ProjectManager[] @relation("ProjectManagerUser")
  projectMembers  ProjectMember[]  @relation("ProjectMemberUser")
  
  // ğŸ†• WBSç”¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  assignedTasks   Task[]           @relation("TaskAssignee")
  assignedWBSEntries WBSEntry[]    @relation("WBSAssignee")

  // ä¼šç¤¾å†…ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€æ„ã«ãªã‚‹ã‚ˆã†è¤‡åˆä¸€æ„åˆ¶ç´„
  @@unique([companyId, email])
  @@map("users")
}

// ä¼šç¤¾ãƒã‚¹ã‚¿
model Company {
  id          String @id @default(cuid())
  code        String @unique  // ä¼šç¤¾ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "00001"ï¼‰
  name        String          // ä¼šç¤¾å
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  divisions   Division[]      // äº‹æ¥­éƒ¨
  users       User[]          // æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼

  @@map("companies")
}

// äº‹æ¥­éƒ¨ãƒã‚¹ã‚¿
model Division {
  id          String @id @default(cuid())
  companyId   String
  code        String          // äº‹æ¥­éƒ¨ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "SI", "CLOUD"ï¼‰
  name        String          // äº‹æ¥­éƒ¨å
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  departments Department[]    // éƒ¨ç½²
  users       User[]          // æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼
  
  @@unique([companyId, code]) // ä¼šç¤¾å†…ã§äº‹æ¥­éƒ¨ã‚³ãƒ¼ãƒ‰ã¯ä¸€æ„
  @@map("divisions")
}

// éƒ¨ç½²ãƒã‚¹ã‚¿
model Department {
  id          String @id @default(cuid())
  divisionId  String
  code        String          // éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "DIST", "FIN"ï¼‰
  name        String          // éƒ¨ç½²å
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  division    Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  groups      Group[]         // ã‚°ãƒ«ãƒ¼ãƒ—
  users       User[]          // æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼
  
  @@unique([divisionId, code]) // äº‹æ¥­éƒ¨å†…ã§éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã¯ä¸€æ„
  @@map("departments")
}

// ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚¹ã‚¿
model Group {
  id           String @id @default(cuid())
  departmentId String
  code         String          // Grã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "EC"ï¼‰
  name         String          // ã‚°ãƒ«ãƒ¼ãƒ—å
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  users        User[]          // æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼
  
  @@unique([departmentId, code]) // éƒ¨ç½²å†…ã§Grã‚³ãƒ¼ãƒ‰ã¯ä¸€æ„
  @@map("groups")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String
  startDate   DateTime
  endDate     DateTime?
  status      ProjectStatus
  managerId   String?  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  phases      Phase[]
  tasks       Task[]
  timeEntries TimeEntry[]
  managers    ProjectManager[]
  members     ProjectMember[]
  wbsEntries  WBSEntry[]

  @@map("projects")
}

model Phase {
  id          String      @id @default(cuid())
  projectId   String
  name        String
  description String?
  order       Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]
  timeEntries TimeEntry[]
  wbsEntries  WBSEntry[]

  @@map("phases")
}

model Task {
  id             String      @id @default(cuid())
  phaseId        String
  projectId      String
  name           String
  description    String?
  estimatedHours Float       @default(0)
  order          Int
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  // ğŸ†• WBSç”¨æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå…¨ã¦NULLè¨±å¯ã§å®‰å…¨ã«è¿½åŠ ï¼‰
  plannedStartDate  DateTime?     // äºˆå®šé–‹å§‹æ—¥
  plannedEndDate    DateTime?     // äºˆå®šçµ‚äº†æ—¥
  actualStartDate   DateTime?     // å®Ÿéš›ã®é–‹å§‹æ—¥
  actualEndDate     DateTime?     // å®Ÿéš›ã®çµ‚äº†æ—¥
  status           TaskStatus @default(NOT_STARTED)  // ä½œæ¥­çŠ¶æ³
  assigneeId       String?        // æ‹…å½“è€…ID
  
  // æ—¢å­˜ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
  phase          Phase       @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  project        Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timeEntries    TimeEntry[]
  
  // ğŸ†• æ–°è¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  assignee       User?       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  wbsEntries     WBSEntry[]

  @@map("tasks")
}

model TimeEntry {
  id          String   @id @default(cuid())
  userId      String
  projectId   String
  phaseId     String
  taskId      String
  date        DateTime
  hours       Float
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  phase       Phase    @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆå¤šå¯¾å¤šï¼‰
model ProjectManager {
  id        String  @id @default(cuid())
  projectId String
  userId    String
  role      String? // "PRIMARY", "SECONDARY" ãªã©
  createdAt DateTime @default(now())
  
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation("ProjectManagerUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
  @@map("project_managers")
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ï¼ˆå¤šå¯¾å¤šï¼‰
model ProjectMember {
  id        String  @id @default(cuid())
  projectId String
  userId    String
  role      String? // "DEVELOPER", "TESTER", "ANALYST" ãªã©
  joinDate  DateTime @default(now())
  leaveDate DateTime?
  createdAt DateTime @default(now())
  
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation("ProjectMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
  @@map("project_members")
}

enum Role {
  ADMIN
  MANAGER
  MEMBER
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
}

// WBSã‚¨ãƒ³ãƒˆãƒªï¼ˆç‹¬ç«‹ã—ãŸä½œæ¥­ç®¡ç†ï¼‰
model WBSEntry {
  id                String      @id @default(cuid())
  name              String      // ä½œæ¥­å
  description       String?     // ä½œæ¥­èª¬æ˜
  
  // é–¢é€£ä»˜ã‘ï¼ˆã©ã¡ã‚‰ã‹ã¯å¿…é ˆã€ä¸¡æ–¹è¨­å®šã‚‚å¯èƒ½ï¼‰
  taskId            String?     // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã¨ã®é–¢é€£ä»˜ã‘ï¼ˆä»»æ„ï¼‰
  projectId         String?     // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®ç›´æ¥é–¢é€£ä»˜ã‘ï¼ˆä»»æ„ï¼‰
  phaseId           String?     // ãƒ•ã‚§ãƒ¼ã‚ºã¨ã®é–¢é€£ä»˜ã‘ï¼ˆä»»æ„ï¼‰
  
  // æ‹…å½“è€…
  assigneeId        String?     // æ‹…å½“è€…ID
  
  // äºˆå®š
  plannedStartDate  DateTime?   // äºˆå®šé–‹å§‹æ—¥
  plannedEndDate    DateTime?   // äºˆå®šçµ‚äº†æ—¥
  estimatedHours    Float       @default(0) // äºˆå®šå·¥æ•°
  
  // å®Ÿç¸¾
  actualStartDate   DateTime?   // å®Ÿéš›ã®é–‹å§‹æ—¥
  actualEndDate     DateTime?   // å®Ÿéš›ã®çµ‚äº†æ—¥
  actualHours       Float       @default(0) // å®Ÿç¸¾å·¥æ•°
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status            TaskStatus  @default(NOT_STARTED)
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  task              Task?       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project           Project?    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase             Phase?      @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  assignee          User?       @relation("WBSAssignee", fields: [assigneeId], references: [id])
  
  @@map("wbs_entries")
}

enum TaskStatus {
  NOT_STARTED      // æœªå¯¾å¿œ
  IN_PROGRESS      // å¯¾å¿œä¸­
  REVIEW_PENDING   // ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡
  REVIEWED         // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ
  COMPLETED        // å®Œäº†
}
